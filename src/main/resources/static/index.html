<!doctype html>
<html lang="cs">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Spr√°vce ‚Äì testovac√≠ FE</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NXZBfNQZ0WwIgtl7mKpVtGfZ8q3j6u1R5QqY+4o8E=" crossorigin=""/>
    <link rel="stylesheet" href="/css/styles.css"/>
</head>
<body class="app">
<header class="app-header">
    <div>
        <h2 class="app-title">Spr√°vce ‚Äì ud√°losti & alerty (MVP)</h2>
        <div class="muted">Vol√° BE: <code>/event</code>, <code>/event/{id}</code>, <code>POST /event/{id}</code>, <code>/api/alerts</code>, <code>POST /user/ban/{id}</code></div>
    </div>
    <div class="header-actions">
        <span class="muted">Auto-refresh: <code>10s</code></span>
        <button class="btn ghost" onclick="refreshAll()">‚Üª Obnovit</button>
        <form method="post" action="/logout"><button type="submit" class="btn danger">‚éã Odhl√°sit se</button></form>
    </div>
</header>

<div class="wrap">
    <!-- LEV√ù PANEL: EVENTY -->
    <div class="card">
        <div class="row">
            <strong>Ud√°losti</strong>
            <div class="muted" id="eventsCount"></div>
        </div>
        <div id="list" class="list">Naƒç√≠t√°m‚Ä¶</div>
    </div>

    <!-- PRAV√ù PANEL: ALERTY + DETAIL + MAPA -->
    <div class="card">
        <div class="cols">
            <div>
                <div class="row">
                    <strong>Alerty (podez≈ôel√©)</strong>
                    <div class="muted" id="alertsCount"></div>
                </div>
                <div id="alertsList" class="list list-small">Naƒç√≠t√°m‚Ä¶</div>
            </div>
            <div id="detailBox">
                <div id="detail"><em>Vyber ud√°lost vlevo nebo klikni na alert.</em></div>
                <div id="map" class="map"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script>
    // Leaflet ikonky fallback
    (function(){
        const Icon = L.Icon.Default;
        Icon.mergeOptions({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
        });
    })();

    const api = {
        listEvents: () => fetch('/event').then(r => r.json()),
        getEvent: (id) => fetch(`/event/${id}`).then(r => r.json()),
        decide: (id, approved) => fetch(`/event/${id}`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ uuid:id, approved })
        }),
        listAlerts: () => fetch('/api/alerts').then(r => r.json()),
        ban: (userId) => fetch(`/user/ban/${userId}`, { method:'POST' }),
    };

    let state = { events:[], alerts:[], alertsByEventId:new Map(), selected:null, map:null, marker:null, timer:null };

    async function refreshAll(){ await Promise.all([loadAlerts(), loadEvents()]); }

    async function loadEvents() {
        try {
            const data = await api.listEvents();
            state.events = Array.isArray(data) ? data : [];
            document.getElementById('eventsCount').textContent = `${state.events.length} polo≈æek`;
            renderEventList();
            if (state.selected) {
                const updated = state.events.find(x => x.id === state.selected.id);
                if (updated) selectEvent(updated.id); else clearDetail();
            }
        } catch (e) {
            document.getElementById('list').innerHTML = '<div class="alert">Chyba p≈ôi naƒç√≠t√°n√≠ /event</div>';
            console.error(e);
        }
    }

    async function loadAlerts() {
        try {
            const data = await api.listAlerts();
            state.alerts = Array.isArray(data) ? data : [];
            document.getElementById('alertsCount').textContent = `${state.alerts.length} polo≈æek`;
            state.alertsByEventId = new Map();
            for (const a of state.alerts) if (a.eventId) state.alertsByEventId.set(a.eventId, a);
            renderAlertsList();
            renderEventList();
        } catch (e) {
            document.getElementById('alertsList').innerHTML = '<div class="alert">Chyba p≈ôi naƒç√≠t√°n√≠ /api/alerts</div>';
            console.error(e);
        }
    }

    function renderEventList() {
        const list = document.getElementById('list');
        if (!state.events.length) { list.innerHTML = '<div class="muted">≈Ω√°dn√© ud√°losti v DB.</div>'; return; }
        list.innerHTML = state.events.map(e => {
            const suspicious = state.alertsByEventId.has(e.id);
            const badge = suspicious ? `<span class="badge">ALERT</span>` : '';
            return `
        <div class="item ${suspicious ? 'danger' : ''}" onclick="selectEvent('${e.id}')">
          <div><strong>${escapeHtml(e.nazev || '(bez n√°zvu)')}</strong>${badge}</div>
          <div class="muted">${escapeHtml(e.popis || '')}</div>
        </div>`;
        }).join('');
    }

    function renderAlertsList() {
        const box = document.getElementById('alertsList');
        if (!state.alerts.length) { box.innerHTML = '<div class="muted">≈Ω√°dn√© alerty.</div>'; return; }
        box.innerHTML = state.alerts.map(a => `
      <div class="item" onclick="openAlert('${a.id}')">
        <div><strong>${escapeHtml(a.title || a.message || 'Alert')}</strong></div>
        ${a.eventId ? `<div class="muted">event: <code>${a.eventId}</code></div>` : ''}
      </div>`).join('');
    }

    async function openAlert(alertId) {
        const a = state.alerts.find(x => x.id === alertId);
        if (a && a.eventId) await selectEvent(a.eventId);
        else alert('Alert nem√° p≈ôi≈ôazen√Ω eventId.');
    }

    async function selectEvent(id) {
        try {
            const ev = await api.getEvent(id);
            state.selected = ev;
            renderDetail(ev);
            ensureMap(ev);
        } catch (e) {
            console.error(e);
            alert('Nepoda≈ôilo se naƒç√≠st detail ud√°losti.');
        }
    }

    function clearDetail() {
        state.selected = null;
        document.getElementById('detail').innerHTML = '<em>Vyber ud√°lost vlevo nebo klikni na alert.</em>';
        if (state.marker && state.map) { state.map.removeLayer(state.marker); state.marker = null; }
    }

    function renderDetail(ev) {
        const suspicious = state.alertsByEventId.has(ev.id);
        const d = document.getElementById('detail');
        d.innerHTML = `
      <h3 class="detail-title">${escapeHtml(ev.nazev || '(bez n√°zvu)')}${suspicious ? ' <span class="badge">ALERT</span>' : ''}</h3>
      <div class="muted">ID: <code>${ev.id}</code></div>
      <p>${escapeHtml(ev.popis || '')}</p>
      <div>üìç Lat/Lng: <code>${ev.lat ?? '-'}</code> / <code>${ev.lng ?? '-'}</code></div>
      <div>üë§ U≈æivatel: <code>${ev.userId || '-'}</code></div>
      <div class="btns">
        <button class="btn success" onclick="onApprove('${ev.id}')">‚úÖ Povolit</button>
        <button class="btn danger" onclick="onDeny('${ev.id}')">‚ùå Zam√≠tnout</button>
        <button class="btn ghost" onclick="onBan('${ev.userId}')">‚õî Ban u≈æivatele</button>
      </div>`;
    }

    async function onApprove(id) {
        try { await api.decide(id, true); await refreshAll(); alert('Ud√°lost schv√°lena (odesl√°no na srumec_events).'); }
        catch (e) { console.error(e); alert('Schv√°len√≠ selhalo.'); }
    }

    async function onDeny(id) {
        if (!confirm('Opravdu zam√≠tnout a smazat tuto ud√°lost?')) return;
        try { await api.decide(id, false); await refreshAll(); alert('Ud√°lost zam√≠tnuta a smaz√°na.'); }
        catch (e) { console.error(e); alert('Zam√≠tnut√≠ selhalo.'); }
    }

    async function onBan(userId) {
        if (!userId) { alert('Chyb√≠ userId'); return; }
        if (!confirm('Opravdu zabanovat tohoto u≈æivatele?')) return;
        try { await api.ban(userId); alert('U≈æivatel zabanov√°n (odesl√°no na srumec_users).'); }
        catch (e) { console.error(e); alert('Ban se nepoda≈ôil.'); }
    }

    function ensureMap(ev) {
        const lat = Number(ev.lat), lng = Number(ev.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        if (!state.map) {
            state.map = L.map('map', { zoomControl: true }).setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(state.map);
        } else {
            state.map.setView([lat, lng], state.map.getZoom() || 13, { animate: true });
        }

        if (state.marker) state.map.removeLayer(state.marker);
        state.marker = L.marker([lat, lng]).addTo(state.map).bindPopup(ev.nazev || 'Ud√°lost');

        requestAnimationFrame(() => state.map.invalidateSize(true));
        setTimeout(() => state.map.invalidateSize(true), 150);
    }

    function escapeHtml(s) {
        return (s ?? '').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }

    window.addEventListener('resize', () => { if (state.map) state.map.invalidateSize(true); });
    refreshAll();
    state.timer = setInterval(refreshAll, 10000);
</script>
</body>
</html>
